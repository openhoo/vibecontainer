name: Docker

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch

  determine-flavors:
    needs: tag
    runs-on: ubuntu-latest
    outputs:
      flavors_json: ${{ steps.detect.outputs.flavors_json }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine flavors to build
        id: detect
        run: |
          set -euo pipefail

          all_flavors='["base","claude","codex"]'

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base_sha="${{ github.event.before }}"
          head_sha="${{ github.sha }}"

          if [ -z "$base_sha" ] || [ "$base_sha" = "0000000000000000000000000000000000000000" ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed_files="$(git diff --name-only "$base_sha" "$head_sha")"
          only_dockerfile=1
          while IFS= read -r file; do
            [ -n "$file" ] || continue
            if [ "$file" != "Dockerfile" ]; then
              only_dockerfile=0
              break
            fi
          done <<< "$changed_files"

          if [ "$only_dockerfile" -ne 1 ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          docker_diff="$(git diff -U0 "$base_sha" "$head_sha" -- Dockerfile)"

          claude_changed=0
          codex_changed=0
          if grep -Eq '^[+-]ARG CLAUDE_CODE_VERSION=' <<< "$docker_diff"; then
            claude_changed=1
          fi
          if grep -Eq '^[+-]ARG CODEX_VERSION=' <<< "$docker_diff"; then
            codex_changed=1
          fi

          other_docker_changes="$(
            grep -E '^[+-]' <<< "$docker_diff" \
              | grep -Ev '^\+\+\+|^---' \
              | grep -Ev '^[+-]ARG (CLAUDE_CODE_VERSION|CODEX_VERSION)=' \
              || true
          )"

          if [ -n "$other_docker_changes" ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$claude_changed" -eq 1 ] && [ "$codex_changed" -eq 1 ]; then
            echo 'flavors_json=["claude","codex"]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$claude_changed" -eq 1 ]; then
            echo 'flavors_json=["claude"]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$codex_changed" -eq 1 ]; then
            echo 'flavors_json=["codex"]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"

  build:
    needs:
      - tag
      - determine-flavors
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
        flavor: ${{ fromJSON(needs.determine-flavors.outputs.flavors_json) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Prepare
        run: |
          platform="${{ matrix.platform }}"
          echo "PLATFORM_PAIR=${platform//\//-}" >> "$GITHUB_ENV"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          target: ${{ matrix.flavor }}
          platforms: ${{ matrix.platform }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    runs-on: ubuntu-latest
    needs:
      - tag
      - determine-flavors
      - build
    strategy:
      fail-fast: false
      matrix:
        flavor: ${{ fromJSON(needs.determine-flavors.outputs.flavors_json) }}
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Download digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-${{ matrix.flavor }}-*
          merge-multiple: true

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract provider versions
        id: versions
        run: |
          claude="$(sed -n 's/^ARG CLAUDE_CODE_VERSION=//p' Dockerfile)"
          codex="$(sed -n 's/^ARG CODEX_VERSION=//p' Dockerfile)"
          if [ -z "$claude" ] || [ -z "$codex" ]; then
            echo "Error: failed to extract CLAUDE_CODE_VERSION or CODEX_VERSION from Dockerfile."
            exit 1
          fi
          echo "claude=$claude" >> "$GITHUB_OUTPUT"
          echo "codex=$codex" >> "$GITHUB_OUTPUT"

      - name: Create manifest list and push
        id: manifest
        working-directory: ${{ runner.temp }}/digests
        env:
          NEW_TAG: ${{ needs.tag.outputs.new_tag }}
          FLAVOR: ${{ matrix.flavor }}
          CLAUDE_VERSION: ${{ steps.versions.outputs.claude }}
          CODEX_VERSION: ${{ steps.versions.outputs.codex }}
        run: |
          set -euo pipefail
          image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          case "$FLAVOR" in
            base)
              tags=(
                "${image}:${NEW_TAG}"
                "${image}:latest"
                "${image}:sha-${GITHUB_SHA}"
              )
              ;;
            claude)
              tags=(
                "${image}:claude"
                "${image}:claude-${NEW_TAG}"
                "${image}:claude-code-${CLAUDE_VERSION}"
              )
              ;;
            codex)
              tags=(
                "${image}:codex"
                "${image}:codex-${NEW_TAG}"
                "${image}:codex-cli-${CODEX_VERSION}"
              )
              ;;
            *)
              echo "Error: unsupported flavor '$FLAVOR'."
              exit 1
              ;;
          esac

          digest_refs=()
          for digest_file in *; do
            [ -f "$digest_file" ] || continue
            digest_refs+=("${image}@sha256:${digest_file}")
          done

          if [ "${#digest_refs[@]}" -eq 0 ]; then
            echo "Error: no digest artifacts found to merge."
            exit 1
          fi

          tag_args=()
          for tag in "${tags[@]}"; do
            tag_args+=("-t" "$tag")
          done

          docker buildx imagetools create "${tag_args[@]}" "${digest_refs[@]}"

          echo "primary_tag=${tags[0]}" >> "$GITHUB_OUTPUT"
          {
            echo "tags<<EOF"
            printf '%s\n' "${tags[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Inspect image
        run: |
          docker buildx imagetools inspect "${{ steps.manifest.outputs.primary_tag }}"

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: "v2.2.4"

      - name: Sign the published Docker image
        env:
          TAGS: ${{ steps.manifest.outputs.tags }}
          PRIMARY_TAG: ${{ steps.manifest.outputs.primary_tag }}
        run: |
          set -euo pipefail
          inspect_output="$(docker buildx imagetools inspect "$PRIMARY_TAG")"
          digest="$(awk '/^Digest:/ { print $2; exit }' <<< "$inspect_output")"
          if ! [[ "$digest" =~ ^sha256:[a-f0-9]{64}$ ]]; then
            echo "Error: failed to extract a valid image digest for $PRIMARY_TAG (got: '$digest')."
            exit 1
          fi
          while IFS= read -r tag; do
            [ -n "$tag" ] || continue
            cosign sign --yes "${tag}@${digest}"
          done <<< "$TAGS"
