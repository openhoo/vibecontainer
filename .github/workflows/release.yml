name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch

  detect:
    needs: tag
    runs-on: ubuntu-latest
    outputs:
      cli_changed: ${{ steps.detect.outputs.cli_changed }}
      flavors_json: ${{ steps.detect.outputs.flavors_json }}
      any_docker: ${{ steps.detect.outputs.any_docker }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          set -euo pipefail

          all_flavors='["base","claude","codex"]'

          # workflow_dispatch: build everything
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "cli_changed=true" >> "$GITHUB_OUTPUT"
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base_sha="${{ github.event.before }}"
          head_sha="${{ github.sha }}"

          if [ -z "$base_sha" ] || [ "$base_sha" = "0000000000000000000000000000000000000000" ]; then
            echo "cli_changed=true" >> "$GITHUB_OUTPUT"
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed_files="$(git diff --name-only "$base_sha" "$head_sha")"

          # Detect CLI changes
          cli_changed=false
          while IFS= read -r file; do
            [ -n "$file" ] || continue
            case "$file" in
              cmd/*|internal/*|go.mod|go.sum)
                cli_changed=true
                break
                ;;
            esac
          done <<< "$changed_files"
          echo "cli_changed=$cli_changed" >> "$GITHUB_OUTPUT"

          # Detect Docker changes — check if ONLY Dockerfile changed
          docker_files_changed=false
          only_dockerfile=1
          while IFS= read -r file; do
            [ -n "$file" ] || continue
            case "$file" in
              Dockerfile|*entrypoint*.sh|.tmux.conf|providers/*|docker-compose.yml)
                docker_files_changed=true
                ;;
            esac
            if [ "$file" != "Dockerfile" ]; then
              only_dockerfile=0
            fi
          done <<< "$changed_files"

          # If no docker-related files changed, skip Docker entirely
          if [ "$docker_files_changed" = "false" ]; then
            echo 'flavors_json=[]' >> "$GITHUB_OUTPUT"
            echo "any_docker=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If non-Dockerfile docker files changed, build all flavors
          if [ "$only_dockerfile" -ne 1 ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Only Dockerfile changed — fine-grained flavor detection
          docker_diff="$(git diff -U0 "$base_sha" "$head_sha" -- Dockerfile)"

          claude_changed=0
          codex_changed=0
          if grep -Eq '^[+-]ARG CLAUDE_CODE_VERSION=' <<< "$docker_diff"; then
            claude_changed=1
          fi
          if grep -Eq '^[+-]ARG CODEX_VERSION=' <<< "$docker_diff"; then
            codex_changed=1
          fi

          other_docker_changes="$(
            grep -E '^[+-]' <<< "$docker_diff" \
              | grep -Ev '^\+\+\+|^---' \
              | grep -Ev '^[+-]ARG (CLAUDE_CODE_VERSION|CODEX_VERSION)=' \
              || true
          )"

          if [ -n "$other_docker_changes" ]; then
            echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$claude_changed" -eq 1 ] && [ "$codex_changed" -eq 1 ]; then
            echo 'flavors_json=["claude","codex"]' >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$claude_changed" -eq 1 ]; then
            echo 'flavors_json=["claude"]' >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$codex_changed" -eq 1 ]; then
            echo 'flavors_json=["codex"]' >> "$GITHUB_OUTPUT"
            echo "any_docker=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Dockerfile changed but no version ARGs changed and no other changes
          echo "flavors_json=$all_flavors" >> "$GITHUB_OUTPUT"
          echo "any_docker=true" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # CLI binary build
  # ---------------------------------------------------------------------------
  cli-build:
    needs: [tag, detect]
    if: needs.detect.outputs.cli_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          ext=""
          if [ "$GOOS" = "windows" ]; then ext=".exe"; fi
          out="vibecontainer-${GOOS}-${GOARCH}${ext}"
          go build -trimpath \
            -ldflags="-s -w -X main.version=${{ needs.tag.outputs.new_tag }} -X main.commit=${{ github.sha }} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o "$out" \
            ./cmd/vibecontainer

      - name: Upload binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cli-${{ matrix.goos }}-${{ matrix.goarch }}
          path: vibecontainer-*
          if-no-files-found: error
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Docker image build (per-platform)
  # ---------------------------------------------------------------------------
  docker-build:
    needs: [tag, detect]
    if: needs.detect.outputs.any_docker == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
        flavor: ${{ fromJSON(needs.detect.outputs.flavors_json) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Prepare
        run: |
          platform="${{ matrix.platform }}"
          echo "PLATFORM_PAIR=${platform//\//-}" >> "$GITHUB_ENV"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          target: ${{ matrix.flavor }}
          platforms: ${{ matrix.platform }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.flavor }}-${{ env.PLATFORM_PAIR }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Docker manifest merge + cosign signing
  # ---------------------------------------------------------------------------
  docker-merge:
    needs: [tag, detect, docker-build]
    if: needs.detect.outputs.any_docker == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        flavor: ${{ fromJSON(needs.detect.outputs.flavors_json) }}
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Download digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-${{ matrix.flavor }}-*
          merge-multiple: true

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract provider versions
        id: versions
        run: |
          claude="$(sed -n 's/^ARG CLAUDE_CODE_VERSION=//p' Dockerfile)"
          codex="$(sed -n 's/^ARG CODEX_VERSION=//p' Dockerfile)"
          if [ -z "$claude" ] || [ -z "$codex" ]; then
            echo "Error: failed to extract CLAUDE_CODE_VERSION or CODEX_VERSION from Dockerfile."
            exit 1
          fi
          echo "claude=$claude" >> "$GITHUB_OUTPUT"
          echo "codex=$codex" >> "$GITHUB_OUTPUT"

      - name: Create manifest list and push
        id: manifest
        working-directory: ${{ runner.temp }}/digests
        env:
          NEW_TAG: ${{ needs.tag.outputs.new_tag }}
          FLAVOR: ${{ matrix.flavor }}
          CLAUDE_VERSION: ${{ steps.versions.outputs.claude }}
          CODEX_VERSION: ${{ steps.versions.outputs.codex }}
        run: |
          set -euo pipefail
          image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          case "$FLAVOR" in
            base)
              tags=(
                "${image}:${NEW_TAG}"
                "${image}:latest"
                "${image}:sha-${GITHUB_SHA}"
              )
              ;;
            claude)
              tags=(
                "${image}:claude"
                "${image}:claude-${NEW_TAG}"
                "${image}:claude-code-${CLAUDE_VERSION}"
              )
              ;;
            codex)
              tags=(
                "${image}:codex"
                "${image}:codex-${NEW_TAG}"
                "${image}:codex-cli-${CODEX_VERSION}"
              )
              ;;
            *)
              echo "Error: unsupported flavor '$FLAVOR'."
              exit 1
              ;;
          esac

          digest_refs=()
          for digest_file in *; do
            [ -f "$digest_file" ] || continue
            digest_refs+=("${image}@sha256:${digest_file}")
          done

          if [ "${#digest_refs[@]}" -eq 0 ]; then
            echo "Error: no digest artifacts found to merge."
            exit 1
          fi

          tag_args=()
          for tag in "${tags[@]}"; do
            tag_args+=("-t" "$tag")
          done

          docker buildx imagetools create "${tag_args[@]}" "${digest_refs[@]}"

          echo "primary_tag=${tags[0]}" >> "$GITHUB_OUTPUT"
          {
            echo "tags<<EOF"
            printf '%s\n' "${tags[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Inspect image
        run: |
          docker buildx imagetools inspect "${{ steps.manifest.outputs.primary_tag }}"

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: "v2.2.4"

      - name: Sign the published Docker image
        env:
          TAGS: ${{ steps.manifest.outputs.tags }}
          PRIMARY_TAG: ${{ steps.manifest.outputs.primary_tag }}
        run: |
          set -euo pipefail
          inspect_output="$(docker buildx imagetools inspect "$PRIMARY_TAG")"
          digest="$(awk '/^Digest:/ { print $2; exit }' <<< "$inspect_output")"
          if ! [[ "$digest" =~ ^sha256:[a-f0-9]{64}$ ]]; then
            echo "Error: failed to extract a valid image digest for $PRIMARY_TAG (got: '$digest')."
            exit 1
          fi
          while IFS= read -r tag; do
            [ -n "$tag" ] || continue
            cosign sign --yes "${tag}@${digest}"
          done <<< "$TAGS"

  # ---------------------------------------------------------------------------
  # GitHub Release
  # ---------------------------------------------------------------------------
  release:
    needs: [tag, detect, cli-build, docker-merge]
    if: "!failure() && !cancelled()"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download CLI artifacts
        if: needs.detect.outputs.cli_changed == 'true' && needs.cli-build.result == 'success'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: cli-artifacts
          pattern: cli-*
          merge-multiple: true

      - name: Generate checksums
        if: needs.detect.outputs.cli_changed == 'true' && needs.cli-build.result == 'success'
        working-directory: cli-artifacts
        run: sha256sum vibecontainer-* > checksums.txt

      - name: Build release body
        id: body
        env:
          NEW_TAG: ${{ needs.tag.outputs.new_tag }}
          CLI_CHANGED: ${{ needs.detect.outputs.cli_changed }}
          ANY_DOCKER: ${{ needs.detect.outputs.any_docker }}
        run: |
          set -euo pipefail
          body=""

          if [ "$CLI_CHANGED" = "true" ]; then
            body="${body}## CLI

          Install the CLI via npm:
          \`\`\`
          npm install -g @openhoo/vibecontainer
          \`\`\`

          Or download a binary from the assets below.

          | Platform | amd64 | arm64 |
          |----------|-------|-------|
          | Linux | \`vibecontainer-linux-amd64\` | \`vibecontainer-linux-arm64\` |
          | macOS | \`vibecontainer-darwin-amd64\` | \`vibecontainer-darwin-arm64\` |
          | Windows | \`vibecontainer-windows-amd64.exe\` | \`vibecontainer-windows-arm64.exe\` |

          "
          fi

          if [ "$ANY_DOCKER" = "true" ]; then
            body="${body}## Docker

          \`\`\`bash
          docker pull ghcr.io/openhoo/vibecontainer:${NEW_TAG}
          \`\`\`

          See the [package page](https://github.com/openhoo/vibecontainer/pkgs/container/vibecontainer) for all available tags.
          "
          fi

          {
            echo "body<<EOF"
            echo "$body"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: ${{ needs.tag.outputs.new_tag }}
          name: ${{ needs.tag.outputs.new_tag }}
          body: ${{ steps.body.outputs.body }}
          generate_release_notes: true
          files: |
            cli-artifacts/vibecontainer-*
            cli-artifacts/checksums.txt
          fail_on_unmatched_files: false

  # ---------------------------------------------------------------------------
  # npm publish
  # ---------------------------------------------------------------------------
  npm-publish:
    needs: [tag, detect, release]
    if: needs.detect.outputs.cli_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642195f882660b323136e8a # v4.4.0
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Set package version and publish
        working-directory: npm
        run: |
          version="${{ needs.tag.outputs.new_tag }}"
          version="${version#v}"
          npm version "$version" --no-git-tag-version
          npm publish --provenance --access public
