name: Snyk Container

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  snyk:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
      - name: Build a Docker image
        run: docker build -t your/image-to-test .
      - name: Run Snyk to check Docker image for vulnerabilities
        continue-on-error: true
        uses: snyk/actions/docker@86b1cee1b8e110a78d528b3e1328a80e218111d2
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: your/image-to-test
          args: --file=Dockerfile --severity-threshold=medium --sarif-file-output=snyk.sarif
      - name: Fix SARIF severity mapping
        run: |
          set -e
          if [ -f snyk.sarif ]; then
            python3 << 'PYEOF'
          import json, re, sys

          try:
              with open('snyk.sarif', 'r') as f:
                  sarif = json.load(f)

              severity_map = {'low': 'low', 'medium': 'medium', 'high': 'high', 'critical': 'critical'}

              for run in sarif.get('runs', []):
                  for rule in run.get('tool', {}).get('driver', {}).get('rules', []):
                      desc = rule.get('shortDescription', {}).get('text', '')
                      match = re.match(r'(Low|Medium|High|Critical) severity', desc, re.IGNORECASE)
                      if match:
                          snyk_level = match.group(1).lower()
                          props = rule.setdefault('properties', {})
                          props['security-severity-level'] = severity_map.get(snyk_level, snyk_level)
                          if 'security-severity' in props:
                              # Remap CVSS score to match Snyk's own severity
                              if snyk_level == 'low':
                                  props['security-severity'] = '3.0'
                              elif snyk_level == 'medium':
                                  props['security-severity'] = '5.0'
                              else:
                                  # Ensure security-severity is a string
                                  props['security-severity'] = str(props['security-severity'])

              with open('snyk.sarif.tmp', 'w') as f:
                  json.dump(sarif, f, indent=2)
          except Exception as e:
              print(f"Error processing SARIF file: {e}", file=sys.stderr)
              sys.exit(1)
          PYEOF
            mv -f snyk.sarif.tmp snyk.sarif
          fi
      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@ef618feace3c4838ae42b239ab86e8fb46437508
        with:
          sarif_file: snyk.sarif
